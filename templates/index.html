<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Job Listings</title>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Attach event listeners to status select dropdowns
            document.querySelectorAll(".status-select").forEach(function (select) {
                select.addEventListener("change", function () {
                    const jobId = this.dataset.jobId;
                    const siteId = this.dataset.siteId;
                    const status = this.value;
                    console.log("Job ID:", jobId, "Site ID:",siteId, "Status:", status);
                    fetch("/update_status", {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ job_id: jobId, site_id: siteId, status: status })
                    }).then(response => {
                        if (!response.ok) {
                            alert("Failed to update status.");
                        } else {
                            applyFilters(); // Reapply filters after status change
                        }
                    });
                });
            });
        
            // Attach event listeners to filter checkboxes
            document.getElementById("hide-applied").addEventListener("change", applyFilters);
            document.getElementById("hide-not-interested").addEventListener("change", applyFilters);
            document.getElementById("hide-unlisted").addEventListener("change", applyFilters);
        
            function applyFilters() {
                const hideApplied = document.getElementById("hide-applied").checked;
                const hideNotInterested = document.getElementById("hide-not-interested").checked;
                const hideUnlisted = document.getElementById("hide-unlisted").checked;
        
                document.querySelectorAll("table tr").forEach(row => {
                    const select = row.querySelector(".status-select");
                    if (!select) return; // skip header row
                    
                    const status = select.value;
                    let shouldHide = false;
        
                    if (hideApplied && status === "applied") {
                        shouldHide = true;
                    }
        
                    if (hideNotInterested && status === "not_interested") {
                        shouldHide = true;
                    }

                    if (hideUnlisted && status === "unlisted") {
                        shouldHide = true;
                    }
        
                    row.style.display = shouldHide ? "none" : "";
                });
                applyZebraStripes();
            }
            
            function applyZebraStripes() {
                const rows = Array.from(document.querySelectorAll("table tr"))
                    .filter(row => row.querySelector(".status-select") && row.style.display !== "none");

                rows.forEach((row, index) => {
                    row.style.backgroundColor = (index % 2 === 0) ? "#ffffff" : "#f2f2f2";
                });
            }

            applyFilters(); // Initial call on load
            
        });
        </script>
        <style>
        
            table th {
                background-color: #dddddd;
            }
            table td {
                text-align: center;
                padding: 2px;
            }
        </style>
</head>
<body>
    <div style="text-align:center; margin-bottom: 1em;">
        <label><input type="checkbox" id="hide-applied" checked> Hide Applied</label>
        <label><input type="checkbox" id="hide-not-interested" checked> Hide Not Interested</label>
        <label><input type="checkbox" id="hide-unlisted" checked> Hide Unlisted</label>
    </div>
    <h1>Job Listings</h1>
    <table border="1" align="center" max-width="80%">
        <tr>
            <th>Company</th>
            <th>Title</th>
            <th>Location</th>
            <th>Remote</th>
            <th>Hybrid</th>
            <th>Last Seen</th>
            <th>Apply</th>
            <th>Status</th>
        </tr>
        {% for job in jobs %}
        <tr>
            <td>{{ job[2] }}</td>
            <td>{{ job[1] }}</td>
            <td>{% if job[4] is not none %} {{ job[4] }} {% endif %} {% if job[5] is not none %}  {{ job[5] }} {% endif %} {% if job[6] is not none %} {{ job[6] }} {% endif %}</td>
            <td>{% if job[7] == 1 %} TRUE {% endif %}</td>
            <td>{% if job[8] == 1 %} TRUE {% endif %}</td>
            <td>{{ job[9] }}</td>
            <td>{% if job[3] %}<a target="_blank" href="{{ job[3] }}">{{ job[3]|truncate(50) }}{% endif %}</a></td>
            <td>
                <select class="status-select" data-job-id="{{ job[0] }}" data-site-id="{{ job[10] }}">
                    <option value="" {% if job[12] == '' %}selected{% endif %}>-</option>
                    <option value="applied" {% if job[12] == 'applied' %}selected{% endif %}>Applied</option>
                    <option value="not_interested" {% if job[12] == 'not_interested' %}selected{% endif %}>Not Interested</option>
                    <option value="unlisted" {% if job[12] == 'unlisted' %}selected{% endif %}>Unlisted</option>
                </select>
            </td>
        </tr>
        {% endfor %}
    </table>
</body>
</html>
<!--
{% for job in jobs %}
{{ job[11] }} {{ job[10] }} {{ job[0] }}
 {% endfor %}
-->